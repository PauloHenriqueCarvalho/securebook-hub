name: CI com Build, Teste e SonarCloud

on:
  push:
    branches:
      - master  # Sua branch principal
      - develop
  pull_request:
    branches:
      - master
      - develop
      
jobs:
  build_test_and_scan:
    runs-on: ubuntu-latest # Agente de execu√ß√£o padr√£o para maior compatibilidade

    env:
      DOTNET_VERSION: '8.0.x' 
      PROJECT_SLN: 'SecureBookHub.WebAPI.slnx' # CORRIGIDO: Nome da solution com 'x'
      
    steps:
    - name: 1. Checkout do C√≥digo (Clonar)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Necess√°rio para o SonarCloud analisar o hist√≥rico

    - name: 2. Configurar .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    # --- SonarCloud: Passo 3 - IN√çCIO DA AN√ÅLISE ---
    - name: 3. üîç SonarCloud Scan - Begin
      uses: SonarSource/sonarcloud-github-action/dotnet-scanner@v2
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          /o:"paulohenriquecarvalho" # Sua Organization Key
          /k:"7c31ea47ea1a262758be5d301eb5f684d659e7a0" # Sua Project Key
          /d:sonar.host.url="https://sonarcloud.io"
          /s:"${{ env.PROJECT_SLN }}" # Refer√™ncia √† Solution

    - name: 4. üì¶ Restaurar Depend√™ncias
      run: dotnet restore ${{ env.PROJECT_SLN }}

    - name: 5. üõ†Ô∏è Compilar o Projeto (Build)
      run: dotnet build ${{ env.PROJECT_SLN }} --configuration Release --no-restore

    - name: 6. ‚úÖ Rodar Testes com Cobertura
      # Roda os testes e gera o relat√≥rio no formato OpenCover para o SonarCloud
      run: dotnet test ${{ env.PROJECT_SLN }} --no-build --configuration Release /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:CoverletOutput="./TestResults/"

    # --- SonarCloud: Passo 7 - FIM DA AN√ÅLISE (UPLOAD) ---
    - name: 7. ‚¨ÜÔ∏è SonarCloud Scan - End
      uses: SonarSource/sonarcloud-github-action/dotnet-scanner@v2
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          /d:sonar.login="${{ secrets.SONAR_TOKEN }}"
          /d:sonar.coverageReportPaths="./TestResults/coverage.opencover.xml" # Aponta para o relat√≥rio gerado no passo 6